# Configuración preliminar
library(tidyverse)
library(ggtext)
library(janitor)
library(magrittr)
library(fs)
library(zip)
library(lubridate)
library(readxl)
library(reticulate)
library(writexl)
library(extrafont) 
library(ggrepel)
library(ggplot2)
library(svglite)

options(scipen = 999)

tema_atdt <- function() {
  # sysfonts::font_add_google("Poppins", "Poppins") # Nota: Se puede cambiar por "Montserrat"
  # showtext_auto()
  
  theme_linedraw() + 
    theme(
      # text = element_text(family = "Poppins", color = "grey35"),
      # plot.title = element_text(size = 20, face = "bold", margin = margin(10, 4, 5, 4), 
      #                           family = "Poppins", color = "black"),
      # plot.subtitle = element_text(size = 16, face = "plain", color = "#666666", 
      #                              margin = margin(5, 5, 5, 5), 
      #                              family = "Poppins"),
      # plot.caption = element_text(hjust = 0, size = 10, family = "Poppins"),
      
      # Solo líneas horizontales en el grid
      panel.grid.major.x = element_blank(),  # Elimina líneas verticales mayores
      panel.grid.minor.x = element_blank(),  # Elimina líneas verticales menores
      panel.grid.major.y = element_line(linetype = 2),  # Mantiene líneas horizontales mayores
      panel.grid.minor.y = element_blank(),
      panel.background = element_rect(fill = "transparent", color = NA),
      
      # Ajuste del borde del panel a un gris más tenue
      panel.border = element_rect(color = "#E5E5E5", fill = NA, size = 0.8),
      
      # Ocultar leyendas
      legend.position = "none",
      
      # Ocultar solo los nombres de los ejes, pero mantener las etiquetas de valores
      axis.title = element_blank(),
      axis.text.x = element_text(size = 8, face = "bold", family = "Arial", 
                                 vjust = 0.5, hjust = 1, color = "#767676"),  # Negrita y rotación en eje X
      axis.text.y = element_text(size = 8, face = "bold", family = "Arial",
                                 color = "#767676"),  
      axis.ticks = element_blank(),
      
      strip.background = element_rect(fill = "#525252"),
      strip.text.x = element_text(size = 8, face = "bold", family = "Arial"),
      strip.text.y = element_text(size = 8, face = "bold", family = "Arial")
    )
}

# Crear datos simulados
set.seed(123)

# Años y países
years <- 2013:2024
countries <- c("Sudáfrica", "Colombia", "Turquía", "Brasil", "Chile", 
               "Filipinas", "Iran", "Argentina", "Egipto", "México")

# Simulación de precios
generate_prices <- function(base, drop = 0.02, noise = 0.1) {
  prices <- base * (1 - drop)^(0:(length(years) - 1)) + rnorm(length(years), 0, noise)
  round(pmax(prices, 0.3), 2)
}

# Crear dataframe
precios_filtrados <- do.call(rbind, lapply(countries, function(pais) {
  base_price <- runif(1, 8, 15)
  if (pais == "México") {
    prices <- generate_prices(base_price, drop = 0.07, noise = 0.1)  # caída más fuerte
  } else {
    prices <- generate_prices(base_price)
  }
  data.frame(entity_name = pais, data_year = years, data_value = prices)
}))

# Agregar color
precios_filtrados <- precios_filtrados %>%
  mutate(color_entidad = ifelse(entity_name == "México", "México", "Otras"))

precios_filtrados %<>%
  mutate(color_entidad = ifelse(entity_name == "México", "México", "Otras"))


g1_clean <- ggplot(precios_filtrados, aes(x = data_year, y = data_value, group = entity_name)) +
  geom_line(aes(color = color_entidad, alpha = color_entidad), linewidth = 0.8) +
  scale_color_manual(values = c("México" = "#8B0000", "Otras" = "#10302C")) +
  scale_alpha_manual(values = c("México" = 1, "Otras" = 0.3), guide = "none") +
  scale_y_continuous(labels = scales::label_dollar()) +
  scale_x_continuous(breaks = seq(2013, 2024, 1))+
  labs(y = NULL, x = NULL) +
  tema_atdt() +
  theme(
    panel.background = element_rect(fill = "transparent", color = NA),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.background = element_rect(fill = "transparent"),
    legend.box.background = element_rect(fill = "transparent")
  )

svglite("rstudio/linea_tendencias/bar_chart.svg", width = 15, height = 7)
